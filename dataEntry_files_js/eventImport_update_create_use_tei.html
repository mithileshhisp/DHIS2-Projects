<!DOCTYPE html>
<html lang="en">
<head>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	
<style>
	.custom{
		margin-top:50px;
		width:100%;
		padding:10px;
	}
	.custom-table{
		width:75%;
		font-size:16px;
		margin:auto;
		text-align:center;
	}
	.custom-drop{
		text-align:center;
	}
</style>

</head>

<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-*  custom">
		<button onClick="loadTei()" id="import" style="margin-left: 47%">Start Importing</button><br><br>
</div>
</div>
</div>		
</body>
<script type="text/javascript">

var teiList=[];
function loadTei(){
	$.ajax({
	url: "../api/trackedEntityInstances.json?fields=trackedEntityInstance,orgUnit&program=BgTTdBNKHwc&ou=lZtSBQjZCaX&skipPaging=true",   
	dataType: "json",
	success: function(data){
		for(var i=0;i<data.trackedEntityInstances.length;i++){    
			teiList.push(data.trackedEntityInstances[i]);
		}
		console.log("teiList length = "+ teiList.length);	
		Import();
		},
		error : function(err){
		console.log("teiList error" + JSON.stringify(err));
		loadTei();
		}
	});
	}

function getRegisteredEventId(trackEntityInstance)
{
    var eventID;
        $.ajax({
        async : false,
        type: "GET",
        url: "../api/events.json?trackedEntityInstance="+trackEntityInstance+"&ou=lZtSBQjZCaX&program=BgTTdBNKHwc&programStage=V3cAsse48A7&skipPaging=true",
        success: function(data){
            if(data.events.length > 0){				
                for(var y=0;y<data.events.length;y++)
                {
                    if( data.events[y].status != 'COMPLETED' ){
                        eventID = data.events[y].event;
                    }
                    
                }
            }
            }     
            });
        return eventID;
}	

     function Import(){

      var datevalue = '2018-06-01';
      var valueofdataelement = 'chandigarh';
      var dataElementId = 'SOvdUkMy9kX';

             for(var p1=0;p1<teiList.length;p1++)
                {								
                var trackEntityInstance=teiList[p1].trackedEntityInstance;
                var orgunitId = teiList[p1].orgUnit;

                var event = {
                trackedEntityInstance: trackEntityInstance,
                orgUnit: orgunitId,
                programStage : "V3cAsse48A7",
                program : "BgTTdBNKHwc",
                eventDate: datevalue,
                status : "ACTIVE",
                dataValues:[{
                dataElement: dataElementId,
                value:  valueofdataelement
                }]
                };

                var eventID = getRegisteredEventId(trackEntityInstance);

                if(eventID == undefined)
                    {
                        //to create new event//

                        $.ajax({
                            async: false,
                            type: "POST",
                            dataType: "json",
                            contentType: "application/json",
                            url: '../api/events/',
                            data: JSON.stringify(event),
                            success: function (response) {
                                console.log("Event with tei :",trackEntityInstance);
                                console.log("Household Event added!"); 
                            },
                            error: function (response) {
                                console.log("not Event with tei:",trackEntityInstance);
                                console.log("Household Event not added!");
                            }
                        }); 
					}
					else{
                        //update the existing already created event by new values//
						
						$.ajax({
                            async: false,
                            type: "PUT",
                            dataType: "json",
                            contentType: "application/json",
                            url: '../api/events/'+eventID,
                            data: JSON.stringify(event),
                            success: function (response) {
                                console.log("Updated Event with tei :",trackEntityInstance);
                                console.log("Household Event Updated!"); 
                            },
                            error: function (response) {
                                console.log("not Updated Event with tei:",trackEntityInstance);
                                console.log("Household Event not Updated!");
                            }
                        }); 
					}
                }         
        };

</script>
</br>
</div>
</html>