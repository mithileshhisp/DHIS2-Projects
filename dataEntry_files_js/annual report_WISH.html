
<!-- <link rel="stylesheet" href="../dhis-web-commons/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="../dhis-web-commons/bootstrap/css/bootstrap-theme.min.css">
<script src="../dhis-web-commons/bootstrap/js/bootstrap.min.js"></script>	-->

<link rel="stylesheet" href="../dhis-web-commons/javascripts/ext/resources/css/ext-plugin-gray.css" />
<script src="../dhis-web-commons/javascripts/ext/ext-all.js"></script>
<script src="../dhis-web-commons/javascripts/plugin/chart.js"></script>

<script type="text/javascript">
	var periods = dhis2.report.periods;
	var period = periods[0];
	var orgUnit = dhis2.report.organisationUnit;
	orgUnit.parent = dhis2.report.organisationUnitHierarchy[1];
	orgUnit.parent.parent = dhis2.report.organisationUnitHierarchy[2];

	var orgUnitChildrens = dhis2.report.organisationUnitChildren;
	var stringDEs = "";
	var arrayDEs = stringDEs.split(";");                                                                                                                                                     
		var result=[];	
		var result1=[];
	
	var stt=0;
	var load=1;

	var url = window.location.href;
	var params = url.split('=');
	var gotPeriod=params[2];
	
	var base = "";

	
	
	var s,e;
    var pushPeriods = [];
     var desForChart = "m4l6dkZE3Tb";
	
//	var desForChart = "jIeNJPzlILx";
	//for state and district selection
	var showingTable="datavalue1";

	jQuery( document ).ready( function() {	
	
		$.get("../api/system/info", function(json){
			base = json.contextPath;
			validateReport();
		
			$("#btnExport").click(function(e) {
				window.open('data:application/vnd.ms-excel,'+ encodeURIComponent($('#printing').html()));
				e.preventDefault();
			});
		});
	});



//get period *************************************************************
function getPeriod(pr)
{
	var year = pr.substring(0,4);
	var month = pr.substring(4,6);
	var strMonth="";
	
	if(month=="01" || month=="1")
		strMonth="January";
	else if(month=="02" || month=="2")
		strMonth="February";
	else if(month=="03" || month=="3")
		strMonth="March";
	else if(month=="04" || month=="4")
		strMonth="April";
	else if(month=="05" || month=="5")
		strMonth="May";
	else if(month=="06" || month=="6")
		strMonth="June";
	else if(month=="07" || month=="7")
		strMonth="Junly";
	else if(month=="08" || month=="8")
		strMonth="August";
	else if(month=="09" || month=="9")
		strMonth="September";
	else if(month=="10")
		strMonth="October";
	else if(month=="11")
		strMonth="November";
	else if(month=="12")
		strMonth="December";
	
	return strMonth + " " +year;
}
//************************************************************************

	var selYear = parseInt( gotPeriod.substring(0,4) );
	var pYear = selYear -1;
	
	//var periodsForTable1 = selYear+";"+pYear;
	
	var ytdCYPeriods = [];
	var ytdPYPeriods = [];
	//var periodsForTable1 = "";
	var ytdCYPeriodStr = "";
	var ytdPYPeriodStr = "";
	
	function preparePeriods()
	{		
		ytdCYPeriods.push( selYear );
		ytdCYPeriodStr += selYear+";";
		ytdPYPeriods.push( pYear );
		ytdPYPeriodStr += pYear+";";
		periodsForTable1 = selYear+";"+pYear;		
	}

	var numberofYears = 3;
	var lastXperiods = [];
	var lastXperiodsStr = "";
	var fromDate = "";
	
	
	function getLastXYearPeriods( )
	{
		var year = parseInt( gotPeriod.substring(0,4) );
		var month = parseInt( gotPeriod.substring(4,6) );
		fromDate = (year-numberofYears)+"01";
		
		for( var i=numberofYears; i>=0; i-- )
		{
			for( var j=1; j<=12; j++ )
			{
				if( i==0 && j > month )
				{
					break;
				}
				
				if( j < 10) 
				{
					lastXperiods.push( (year-i)+"0"+j );
					lastXperiodsStr += (year-i)+"0"+j+";";
				}
				else
				{
					lastXperiods.push( (year-i)+""+j );
					lastXperiodsStr += (year-i)+""+j+";";
				}
			}
		}		
	}
	
	function getLastXYearlyPeriods( )
	{		
		for( var i=numberofYears; i>=0; i-- )
		{
			lastXperiods.push( (selYear-i)+"" );
			lastXperiodsStr += (selYear-i)+";";
		}		
	}

	function validateReport()
	{
	loadReport();
		
	}
	
	function loadReport()
	{
		preparePeriods();
		//getLastXYearPeriods();
		getLastXYearlyPeriods();
				
		//document.getElementById('blockName').innerHTML=orgUnit.name;
		//document.getElementById('perd1').innerHTML=getPeriod(gotPeriod);
		//document.getElementById('districtName').innerHTML=orgUnit.parent.name;
		//document.getElementById('stateName').innerHTML=orgUnit.parent.parent.name;
		
		//populateTable1();
		//populateTable2();
		//populateTable3();
		//populateTable3_2();
		//populateTable4();
		//populateTable5();
		//populateTable6();
		getPeriodListBetweenTwoDates(s,e);
		populateChart();
		
		prepareLast3YearChart( desForChart1, "chart1" );
		prepareLast3YearChart( desForChart2, "chart2" );
		//prepareLast3YearChart( desForChart3, "chart3" );
		prepareLast3YearChart( desForChart4, "chart4" );
	}

	var publicOuGroupSetUID = "S43WrJLjMIl";
	var phcOUGroupUID = "fXXlOfR3KNY";
	var chcOUGroupUID = "I5vwf6HSnHT";
	var scOUGroupUID = "qaaIaEGClsl";
	var sdhOUGroupUID = "GrTLCbny9hl";

 
 
	function prepareLast3YearChart( des, chartDiv )
	{	
		var desForChart1Array = des.split(";");
		Ext.onReady(function() {
			
			var chartJson = {
				url: base,
				el: chartDiv,
				type: "line",					
				columns: [ {dimension: "dx", items: [ ]} ],	
				rows: [{dimension: "pe", items: [ ]}],
				filters: [ {dimension: "ou", items: [{id: orgUnit.id}]} ],
				showData: true,
				hideLegend: false,
				title: " ",
				domainAxisTitle: "Periods",
				rangeAxisTitle: "Cases",
				hideEmptyRows: false,
				legendStyle: {}
			};
					
			$.each(lastXperiods, function (index, value) {
				if( parseInt( value ) > 2012 )
					chartJson.rows[0].items.push( {'id': value} );				
			});	
						
			$.each(desForChart1Array, function (index, value) {		
				chartJson.columns[0].items.push( {'id': value} );
			});				
			
			DHIS.getChart( chartJson );
		});	
	}
//new code..


    function getPeriodListBetweenTwoDates(startPeriod,endPeriod){
                var periodList=[];
                //var periodsStr = "";
             //   if( periodType === "Monthly")
                //{
                  //  var startYear = startPeriod.substring(0,4);
                    //var startMonth = startPeriod.substring(4,6);
                      var startYear = "2015";
					  var startMonth = "04";
                    
					//var endYear = endPeriod.substring(0,4);
                   // var endMonth = endPeriod.substring(4,6);

				    var endYear = "2015";
					var endMonth = "12";
                    
					var StartPeriod =  startYear + startMonth;

                    var selectedEndPeriod = endYear + endMonth;
                  //  var lastDayOfSelEndPeriod = new Date(selectedEndPeriod.getFullYear(), selectedEndPeriod.getMonth() + 1, 0);

					
                    //while(firstDayOfStartPeriod <= lastDayOfSelEndPeriod)
					var period ="";
					while(StartPeriod <= selectedEndPeriod)
                    {
                        var month = StartPeriod.getMonth() + 1;
                        month = ( month  ) > 9 ?  month : "0"+ month;

                       // var period = StartPeriod.getFullYear() + ""+month;
						
                        //periodsStr = ( periodsStr == "" ) ? period : ( periodsStr + ";" + period );
						  var period = StartPeriod.getFullYear() +month+";";
						
                        periodList.push( period );

                        firstDayOfStartPeriod.setMonth( firstDayOfStartPeriod.getMonth() + 1 );
                    }
                }





function populateChart(){

console.log("DE--" +desForChart);
 
$.get("../api/analytics?dimension=dx:"+desForChart+"&filter=pe:201404;201405;201406;201407;201408;201409&dimension=ou:efohxmoicar;jlinpH2sARR;zkV6pxczaCF", function(json){
console.log("../api/analytics?dimension=dx:"+desForChart+"&filter=pe:201404;201405;201406;201407;201408;201409&dimension=ou:efohxmoicar;jlinpH2sARR;zkV6pxczaCF");

	console.log("rows length for first url--" +json.rows.length);
	for( var i=0; i < json.rows.length; i++ )
	{
	console.log("rows length--" +json.rows.length);
		  result.push(json.rows[i][2]);
 console.log("1st result--"+result);     
	}
	 	
	
		$.get("../api/analytics?dimension=dx:"+desForChart+"&filter=pe:201504;201505;201506;201507;201508;201509&dimension=ou:efohxmoicar;jlinpH2sARR;zkV6pxczaCF", function(json1){

		console.log("../api/analytics?dimension=dx:"+desForChart+"&filter=pe:201504;201505;201506;201507;201508;201509&dimension=ou:efohxmoicar;jlinpH2sARR;zkV6pxczaCF");
	for( var j=0; j < json1.rows.length; j++ )
	{
	console.log("rows length for second url--" +json1.rows.length);	 
result1.push(json1.rows[j][2]);
 console.log("2nd result--"+result1);	
	}
		
Ext.require('Ext.chart.*');
Ext.require('Ext.layout.container.Fit'); 

Ext.onReady(function () {
    var store = Ext.create('Ext.data.JsonStore', {
        fields: ['year', 'Apr14ToSep14', 'Apr15ToSep15'],
       data: [
                {year: 10, Apr14ToSep14: result[0], Apr15ToSep15: result1[0]},
                {year: 20, Apr14ToSep14: result[1], Apr15ToSep15: result1[1]},
                {year: 30, Apr14ToSep14: result[2], Apr15ToSep15: result1[2]},
				
               
              ]
    });

    var panel1 = Ext.create('widget.panel', {
        width: 600,
        height: 400,
        title: 'Early ANC Registration',
        renderTo: Ext.getBody(),
        layout: 'fit',
        items: {
            xtype: 'chart',
            animate: true,
            shadow: true,
            store: store,
            legend: {
                position: 'right'
            },
            axes: [{
                type: 'Numeric',
                position: 'left',
                fields: ['Apr14ToSep14', 'Apr15ToSep15'],
                title: false,
                grid: true,
              label: {
                   renderer: function(v) {
                   return String(v).replace(/000000$/, 'M');
               }
                },
                roundToDecimal: false
            }, {
                type: 'Category',
                position: 'Bottom',
                fields: ['year'],
                title: false
            }],
            series: [{
                //type: 'bar',
				 type: 'column',
                axis: 'bottom',
                gutter: 80,
                xField: 'year',
                yField: ['Apr14ToSep14', 'Apr15ToSep15'],
                stacked: false,
                tips: {
                    trackMouse: true,
                    width: 65,
                    height: 28,
                    renderer: function(storeItem, item) {
                        this.setTitle(String(item.value[1]));
                    }
                }
            }]
        }
    });
});
})
})
}


	
	
	function getNumberFormat( numberVal, formatChar ){
		return numberVal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, formatChar );	
	}

	
	
	function findTopSCs( topSCCount, deUID, cellID )
	{
		var topSCs = "NONE";
		var year = parseInt( gotPeriod.substring(0,4) );
		var month = gotPeriod.substring(4,6);
		var orgUnitDataJson = [];
		
		$.get("../api/analytics.json?dimension=dx:"+deUID+"&dimension=ou:"+orgUnit.id+";OU_GROUP-"+scOUGroupUID+"&filter=pe:"+year+""+month+"&displayProperty=NAME",function(json)
		{
			console.log( "../api/analytics.json?dimension=dx:"+deUID+"&dimension=ou:"+orgUnit.id+";OU_GROUP-"+scOUGroupUID+"&filter=pe:"+year+""+month+"&displayProperty=NAME" );
			
			json.metaData.ou.forEach(function(child){
				var tempVal = 0;
				tempVal = parseInt( getCellValue( json, deUID, child ) );
				
				orgUnitDataJson.push( {'id': child, 'name': json.metaData.names[child], 'value': tempVal} );
			});
			
			console.log( orgUnitDataJson );
			
			orgUnitDataJson.sort( function( a, b ){
				if ( a.value > b.value )
					return -1;
				if ( a.value < b.value )
					return 1;
				return 0;
			});
			
			console.log( orgUnitDataJson );
			topSCs = "";
			var count = 1;
			$.each(orgUnitDataJson, function () {
				if( count <= topSCCount )
				{
					topSCs += this.name + ", ";								
				}
				count++;	
			});
			
			document.getElementById(cellID).innerHTML= topSCs;
		});		
	}
	
	


//***************************sorting***********************************
	var ChildCount=0;
	var childrens=[];
	var allCodes=[];
	var regionsLoaded=0;


function stringOrgChild(org)
{
		var stringOrg = "";
		var stringCode = "";
		
	$.get("../api/organisationUnits/"+org+".json",function(json)
	{
		ChildCount=0;
		childrens=[];
		allCodes=[];
		
		json.children.forEach(function(child)
		{
			//console.log(child);	
			var childID=child.id;
			var childName=child.name;
			childrens.push([childID,childName]);
			ChildCount++;
		});
		
		sortChildren();
		//alert(ChildCount);
		
		for(var f=0; f<ChildCount; f++)
		{
			var childID=childrens[f][0];
			stringOrg+=childID+";";
		}
		
		if(orgUnit.id=="Z62o5F3NmDg")
		{
			stringOrg+=org;
		}
		
		allCodes.push([stringOrg,stringCode]);

		writelines(stringOrg,stringCode);
	});
}


function sortChildren()
{
	for(var u=0;u<ChildCount;u++)
	{
		for(var k=0; k<ChildCount-1; k++)
		{
			if(childrens[k][1]>childrens[k+1][1])
			{
				var tempID=childrens[k][0];
				var tempCode=childrens[k][1];
				
				childrens[k][1]=childrens[k+1][1];
				childrens[k][0]=childrens[k+1][0];
				childrens[k+1][1]=tempCode;
				childrens[k+1][0]=tempID;
			}
		}
	}
}


//******************************************************************						

function getValueByOUGroupAndDe( json, oug, de )
{
	var result=0;
	
	for( var i=0; i < json.rows.length; i++ )
	{
		if( json.rows[i][1] == de && json.rows[i][0] == oug && json.rows[i][2]!= null )
		{
			result = json.rows[i][2];
			break;
		}
	}
	
	return result;
}

function getValueByDeAndPeriodAndCoc( json, de, p, coc )
{
	var result=0;
	
	for( var i=0; i < json.rows.length; i++ )
	{
		if( json.rows[i][0] == de && json.rows[i][2] == coc && json.rows[i][1] == p && json.rows[i][3]!= null )
		{
			result = json.rows[i][3];
			break;
		}
	}
	
	return result;
}

function getValueByDeAndPeriod( json, de, p )
{
	var result=0;
	
	for( var i=0; i < json.rows.length; i++ )
	{
		if( json.rows[i][0] == de && json.rows[i][1] == p && json.rows[i][2]!= null )
		{
			result = json.rows[i][2];
			break;
		}
	}
	
	return result;
}

function getValueByDeAndPeriods( json, de, periods )
{
	var result=0.0;
	
	for( var i=0; i < json.rows.length; i++ )
	{	
		for( var j=0; j < periods.length; j++ )
		{
			var p = periods[j];
			
			if( json.rows[i][0] == de && json.rows[i][1] == p && json.rows[i][2]!= null )
			{
				result += parseFloat(json.rows[i][2]);
				continue;
			}
		}
	}
	
	return result;
}

function getCellValueByDe( json, de )
{
	var result = 0;
	
	for (var i = 0; i < json.rows.length; i++)
	{
		if( json.rows[i][0] == de && json.rows[i][1] != null )
		{
			result = json.rows[i][1];
			break;
		}
	}
	
	return result;
}
	
	function getCellValue( json, de, orgUnit )
	{
		var result = 0;
		
		for (var i = 0; i < json.rows.length; i++)
		{
			if( json.rows[i][0] == de && json.rows[i][1] == orgUnit && json.rows[i][2] != null )
			{
				result = json.rows[i][2];
				break;
			}
		}
		
		return result;
	}

function getValueSum(json,de,orgGroup){
	var result=0;
	for (var i=0; i < json.rows.length; i++){
		if (json.rows[i][0] == de && json.rows[i][1] == orgGroup && json.rows[i][2]!= null)
		{
			result = parseFloat(json.rows[i][2]);
		}
	}
	return result;
}
function getValueTotal(json,de){
	var result=0;
	for (var i=0; i < json.rows.length; i++){
		if (json.rows[i][0] == de && json.rows[i][2]!= null)
		{
			result=json.rows[i][2];
		}
	}
	return result;
}
</script>


<!-- download script ------------------------------------------------------
		--------------------------------------------------------------------------
		-------------------------------------------------------------------------------------- -->
<script type="text/javascript">
	 var tablesToExcel = (function() {
    var uri ='data:application/vnd.ms-excel;base64,', tmplWorkbookXML ='<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'+'<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>ThaiND</Author><Created>{created}</Created></DocumentProperties>'+'<Styles><Style ss:ID="Default" ss:Name="Normal"><Alignment ss:Horizontal="Center" ss:WrapText="1"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders><Font/><Interior /><NumberFormat /><Protection /></Style><Style ss:ID="s21"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style> <Style ss:ID="s22"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style><Style ss:ID="s64"> <Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center" ss:Indent="0" ss:Rotate="90"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /> </Style> </Styles>'+'{worksheets}</Workbook>', tmplWorksheetXML ='<Worksheet ss:Name="{nameWS}"><Table><Column ss:AutoFitWidth="0" ss:Width="100"/><Column ss:AutoFitWidth="0" ss:Width="150"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/>{rows}</Table></Worksheet>', tmplCellXML ='<Cell ss:StyleID="{sid}" ss:MergeAcross="{mrg}"><Data ss:Type="{dtype}">{data}</Data></Cell>', base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
    , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
	
    return function(tables, wsnames, wbname) {
		var ctx = "";
		var workbookXML = "";
		var worksheetsXML = "";
		var rowsXML = "";
		
		for (var i = 0; i < tables.length; i++) 
		{
		
			if (!tables[i].nodeType) 
			tables[i] = document.getElementById(tables[i]);
		
			for (var j = 0; j < tables[i].rows.length; j++) 
			{
				rowsXML +='<Row>'
				for (var k = 0; k < tables[i].rows[j].cells.length; k++) 
				{
					
					var cols=tables[i].rows[j].cells[k].getAttribute("colspan");
					var rws=tables[i].rows[j].cells[k].getAttribute("rowspan");
					var styl=tables[i].rows[j].cells[k].getAttribute("bgcolor");
					var styl2=tables[i].rows[j].getAttribute("bgcolor");
					var cls=tables[i].rows[j].cells[k].getAttribute("class");
					
						var dataType ='String';
						var dataValue = tables[i].rows[j].cells[k].innerHTML;
						var typeD="";
						var parsed=parseInt(dataValue);
						
						if (parsed==dataValue)
						{
							typeD="Number";
						}
						else
						{
							typeD="String";
						}
					
					
					
					if(styl2)
					{
						if(cols)
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}

						else
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: 0, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: 0, sid: "s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}
					}
				
					else if(styl)
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					}
					
					else
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					
					}
					
				}
				  rowsXML +='</Row>'}
			ctx = {rows: rowsXML, nameWS: wsnames[i] ||'Sheet'+ i};
			worksheetsXML += format(tmplWorksheetXML, ctx);
			rowsXML = "";
      }

		ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
		workbookXML = format(tmplWorkbookXML, ctx);

		console.log(workbookXML);

		var link = document.createElement("A");
		link.href = uri + base64(workbookXML);
		link.download = wbname ||'Workbook.xls';
		link.target ='_blank';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
    }
  })();
</script>