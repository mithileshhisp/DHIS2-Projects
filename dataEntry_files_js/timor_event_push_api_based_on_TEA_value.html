<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        .custom{
            margin-top:50px;
            width:100%;
            padding:10px;
        }
        .custom-table{
            width:75%;
            font-size:16px;
            margin:auto;
            text-align:center;
        }
        .custom-drop{
            text-align:center;
        }
    </style>
    <style>
        thead>tr>td {
            font-weight: bold;
        }
        tbody>tr>td {
            font-weight: bold;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            opacity: 1;
        }

        /* Center the loader  */
        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 150px;
            height: 150px;
            margin: -75px 0 0 -75px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #34B4DB;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Add animation to "page content" */

        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0px;
                opacity: 1
            }
        }

        @keyframes animatebottom {
            from {
                bottom: -100px;
                opacity: 0
            }
            to {
                bottom: 0;
                opacity: 1
            }
        }

        #printing {

            text-align: center;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div  id="importButton">
            <br>
			<label for="importDateLabel">Patient ID code:</label>
			<input type="text" id="importDate" name="importDate"  style="margin-left: 1%">
            <button onClick="readAPI()" disabled id="Import" style="margin-left: 5%">Start Importing Data</button>

        </div>

        <div id="resultDiv">
            <h4 id ="importMsg"></h4>
        </div>

        <!--<div id="loader"> <h4 id = "templateProgress"></h4></div>-->

    </div>
    <br><br>
    <div id="loader"></div>
</div>
</body>
  <script>

  </script>
<script type="text/javascript">
    var finalOu = [];
    var orgUnitMap = [];
    var dataElementMap = [];
    var impCount = "";
    var upCount = "";
    var igCount = "";
    var conflictsDetails = [];
    var regOrgUnitList = [];
    var regPeriodList = [];
    var dataSetUid = 'hxC8LQlCua5';
    var cdsr = { completeDataSetRegistrations: [] };
    var dataSetCompleteRegistration = "";
    $(document).ready(function(){
    document.getElementById("loader").style.display = "none";


	//loadOrgUnits();
	//console.log( finalOu );
	document.getElementById("Import").disabled = false;
	//document.getElementById('importButton').style.display = 'block';
	document.getElementById('resultDiv').style.display = 'none';

	//console.log( dataElementsMapping );

    });

    function readAPI() {
        //document.getElementById("loader").fadeIn();
        //document.getElementById("templateProgress").html(" -> preparing data values to import");
		
		 if( document.getElementById("importDate").value === ""){
            return alert("Please Select Date");
        }
		else{
		
			var tempTEAValue = document.getElementById("importDate").value;
			document.getElementById("Import").disabled = true;
			document.getElementById('importButton').style.display = 'none';
			document.getElementById('resultDiv').style.display = 'block';
			var strMsg = " Import Start.... ";
			var resultMsg = strMsg.bold();
			document.getElementById("importMsg").innerHTML = " Event push Start .... for TEI  -- " +  tempTEAValue;
			/*
			showLoader();
			lockScreen();
			setTimeout(function(){ startImporting() }, 0);
			*/
			$('#loader').show();
			setTimeout(function () {
				startImporting();
			}, 1000);
		}	

    }


    //res.setHeader('Access-Control-Allow-Origin', '*');
    function startImporting() {

	var selectedTEAValue = document.getElementById("importDate").value;
     var tempProgarm = "RUqNUsv6WBp"; 
     var tempProgarmStage = "kqpguGhJ8h5"; 
     var tempEventDate = "2023-10-13";
     var event_payload = {};
     
    //https://links.hispindia.org/timor/api/trackedEntityInstances.json?fields=trackedEntityInstance,orgUnit,enrollments[enrollment,program,orgUnitName,events[event,orgUnit]]&program=RUqNUsv6WBp&ou=Fn51zf6ifbm&ouMode=DESCENDANTS&paging=false&filter=uuZ2ngqdsjm:eq:TIL2872
    
    $.ajax({

        url: '../api/trackedEntityInstances.json?fields=trackedEntityInstance,orgUnit&program=' + tempProgarm + '&ou=Fn51zf6ifbm&ouMode=DESCENDANTS&paging=false&filter=uuZ2ngqdsjm:eq:' + selectedTEAValue,
        async: false,
        type: 'GET',
        crossDomain: true,
        contentType: 'application/json',
        
        success: function ( apiResponse )
        {
            if( apiResponse.trackedEntityInstances.length > 0 )
            {
                console.log( "apiResponse TEI " + apiResponse.trackedEntityInstances[0].trackedEntityInstance );
                console.log( "apiResponse orgUnit " + apiResponse.trackedEntityInstances[0].orgUnit );

                event_payload = {
                    "program": tempProgarm,
                    "orgUnit": apiResponse.trackedEntityInstances[0].orgUnit,
                    "eventDate": tempEventDate,
                    "programStage": tempProgarmStage,
                    "status": "ACTIVE",
                    "trackedEntityInstance": apiResponse.trackedEntityInstances[0].trackedEntityInstance,
                    "dataValues": [
                        {"dataElement": "eHksMNjnBZu", "value": "true"},
                        {"dataElement": "Ypjgv3T8seU", "value": "true"},
                        {"dataElement": "NVWzsivfKlx", "value": "true"},
                        {"dataElement": "lizbBquxcZQ", "value": "true"},
                        {"dataElement": "I1hSmbmMwvw", "value": "true"},
                        {"dataElement": "sV3dTTB8XJC", "value": "false"},
                        {"dataElement": "bImNYrrb41A", "value": "true"},
                        {"dataElement": "W8QAfbEk4pH", "value": "false"},
                        {"dataElement": "uVQQ1fSvdwo", "value": "false"},
                        {"dataElement": "a9Hk3xZkeLl", "value": "false"},
                        {"dataElement": "tVW30uk3oY0", "value": "true"},
                        {"dataElement": "zArrxSefNqD", "value": "false"},
                        {"dataElement": "jjQit5DW2wQ", "value": "false"},
                        {"dataElement": "kVf6uc7qEiV", "value": "false"},
                        {"dataElement": "PMqLQCZWyRx", "value": "false"}

                    ]
                }

            }
            
            else
            {
                alert( " NO record found ");
                location.reload();
                $('#loader').hide();
            }
            
        },
        error: function (apiResponse)
        {
            console.log( "Error" );
            //unLockScreen();
        }
    });

        pushEventDataValue( event_payload );

        $('#loader').hide();

  }


var pushEventDataValue = function (event_dataValue_payload) {

    //var tempEventDataValue = JSON.stringify(event_dataValue_payload);
    var importedEventUid = "";
    if(event_dataValue_payload.dataValues.length != 0){

        $.ajax({
            async: false,
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify(event_dataValue_payload),
            url: '../api/events/',
            success: function (eventPushResponse) {
                alert( " Event Created ");
                $('#loader').hide();
                importedEventUid = eventPushResponse.response.importSummaries[0].reference;
            },
            error: function (response) {
                console.log("Error in post");
                $('#loader').hide();
            }
        });
    }

    document.getElementById('importButton').style.display = 'block';
    document.getElementById("Import").disabled = false;
    document.getElementById('resultDiv').style.display = 'block';

    document.getElementById("importMsg").innerHTML = "";
    document.getElementById("importMsg").innerHTML += "<br>";
    document.getElementById("importMsg").innerHTML += "<br>";
    document.getElementById("importMsg").innerHTML += "<br>";

    document.getElementById("importMsg").innerHTML += "Event Created Successfully With event UID -- " + importedEventUid;

};

</script>
</html>