<!DOCTYPE HTML>
<!--[if IE 7]><html #if( $manifest ) manifest="$manifest" #end class="ie7"><![endif]-->
<!--[if IE 8]><html #if( $manifest ) manifest="$manifest" #end class="ie8"><![endif]-->
<!--[if IE 9]><html #if( $manifest ) manifest="$manifest" #end class="ie9"><![endif]-->
<![if !IE]><html #if( $manifest ) manifest="$manifest" #end><![endif]>
  <head>
	<title>CCEI</title>
    <meta name="description" content="DHIS 2">
    <meta name="keywords" content="DHIS 2">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="../../../dhis-web-commons/font-awesome/css/font-awesome.min.css?_rev=$!{buildRevision}" />
    <link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/javascripts/jQuery/ui/css/redmond/jquery-ui.css?_rev=$!{buildRevision}" />    
    <link type="text/css" rel="stylesheet" media="screen,print" href="../../../dhis-web-commons/css/widgets.css?_rev=$!{buildRevision}" />
    <link type="text/css" rel="stylesheet" media="print" href="../../../dhis-web-commons/css/print.css?_rev=$!{buildRevision}" />
    <link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/css/menu.css?_rev=$!{buildRevision}" />
    <link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/javascripts/jQuery/calendars/css/jquery.calendars.picker.css?_rev=$!{buildRevision}" />

    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/es5-shim.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/es5-sham.min.js?_rev=$!{buildRevision}"></script>

    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/ext/ext-all.js"></script>

    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.min.js?_rev=$!{buildRevision}"></script>
    <!--[if lte IE 8]><script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/placeholders.jquery.min.js?_rev=$!{buildRevision}"></script><![endif]-->
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.utils.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.ext.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.metadata.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.tablesorter.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.upload-1.0.2.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.dhisAjaxSelect.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/ui/jquery-ui.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/ui/jquery.blockUI.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.validate.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.validate.ext.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.cookie.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.glob.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.date.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.tmpl.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.autogrow.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/jquery.fileupload.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/underscore.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/filesize.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.util.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/commons.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/commons.ajax.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/lists.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/periodType.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/date.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/json2.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/validationRules.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.array.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/dhis2/dhis2.select.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/calendars/jquery.calendars.min.js?_rev=$!{buildRevision}"></script>
    <script type="text/javascript" src="../../../dhis-web-commons/javascripts/jQuery/calendars/jquery.calendars.plus.min.js?_rev=$!{buildRevision}"></script>


<script type="text/javascript">

	//var periods = dhis2.report.periods;
	//var period = periods[0];
	//var orgUnit = dhis2.report.organisationUnit;		
	//orgUnit.parent = dhis2.report.organisationUnitHierarchy[1];
	//var orgUnitChildren = dhis2.report.organisationUnitChildren;
	//var orgUnitUIDs = "";
		
	// Input parameters
	/*
	var dataSetUID = "gipnGy2eE4N";
	var orgUnitUID = "amZZzlibrMp";
	var startDate = "2015-04-01";
	var endDate = "2015-08-31";
	var completenessCountSQLVIEW = "VtJhFCFSFVP";
	*/
	var programUID = "QkpY35KBO8d";
	var orgUnitUID = "IWp9dQGM0bS"; //Nc9y09HYxPC
	var startDate = "2015-04-01";
	var endDate = "2015-08-31";
	var completenessCountSQLVIEW = "NLf1k9hBnnH";
	var vvPerFIChild = 100;
	var birthRate = 0.025;
	var dataElements = [{ id: "nrxrpL8nN5f", name: "Population"}, { id: "bgwGSHAdfsO", name: "Supply Interval"}, { id: "wwpg1ygd0KR", name: "Reserve Stock Interval"}];
	var deUIDs = "";
	var curPeriod = "2014";
	var refNetVolumeAttribUID = "joamEHuqmOZ";
	var modelAttributeUID = "xoqj2Wy4SBD";
	
	var programOrgUnits = [];	
	var orgUnitCount = 0;
	
	
	var url = window.location.href;
	var params = url.split('=');
	var gotPeriod=params[2];
	var showingTable="datavalue1";

	var aggDataMap = [];

    // initialisation for push aggregated data
    var dataValue = {};
    var dataValueSet = {};
    var dataValues = [];

    var baseURL = window.location.protocol + "//" + window.location.host + "/" +window.location.pathname.split("/")[1] + "/api";
    var d = new Date();
    var month = d.getMonth() + 1;
    month = ( month  ) > 9 ?  month : "0"+ month;
    var pushPeriod = d.getFullYear() + "" + month;

    var pushDataElements =
            [
                { uid: "kS6oYl9sbkn", coUid: "NAiy3NzCRa0"},
                { uid: "H4uW8k4ZTDI", coUid: "NAiy3NzCRa0"},
                { uid: "TCfjFhYzUgm", coUid: "NAiy3NzCRa0"}
            ];

    // method for push aggregated data
    function pushDataValue()
    {
        //console.log("Data: " +JSON.stringify(dataValueSet));
        //alert( baseURL );

        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            url: baseURL + '/dataValueSets',
            data: JSON.stringify(dataValueSet),
            dataType: 'json',
            type: 'post',
            async: false,
            success: returnSuccess,
            error: returnError

        });

        function returnSuccess(response) {

            var importedDataValueCount = response.importCount.imported;
            var updatedDataValueCount = response.importCount.updated;
            var ignoredDataValueCount = response.importCount.ignored;
            console.log( importedDataValueCount + " : " + updatedDataValueCount + " : " + ignoredDataValueCount );
			alert( "Import Summary: \nImported - " +  importedDataValueCount + "\nUpdated - " + updatedDataValueCount + "\nIgnored - " + ignoredDataValueCount );

        }

        function returnError(xhr, textStatus, errorThrown) {
            $('#loading').hide();
            alert("inside error");
        }
    }






	jQuery( document ).ready( function() {	

		$(".hideInPrint").hide();			
		
		$.each(dataElements, function () {
			deUIDs += this.id + ";";					
		});
			
		loadData();
		
		$("#btnExport").click(function(e) {
			window.open('data:application/vnd.ms-excel,'+ encodeURIComponent($('#printing').html()));
			e.preventDefault();
		});
		
	});

	function hideLoad()
	{
		document.getElementById("cover").style.display="none";
		document.getElementById("loads").style.display="none";
		document.getElementsByTagName("body")[0].style.overflow="scroll";
	}
	
	
	function getPeriod( pr )
	{
		var year = pr.substring(0,4);
		var month = pr.substring(4,6);
		var strMonth="";
		
		if(month=="01" || month=="1") 		strMonth="January";
		else if(month=="02" || month=="2")	strMonth="February";
		else if(month=="03" || month=="3")	strMonth="March";
		else if(month=="04" || month=="4")	strMonth="April";
		else if(month=="05" || month=="5")	strMonth="May";
		else if(month=="06" || month=="6")	strMonth="June";
		else if(month=="07" || month=="7")	strMonth="July";
		else if(month=="08" || month=="8")	strMonth="August";
		else if(month=="09" || month=="9")	strMonth="September";
		else if(month=="10")				strMonth="October";
		else if(month=="11") 				strMonth="November";
		else if(month=="12")				strMonth="December";
		
		return strMonth + " " +year;
	}

	var periodsStr = "";
	var periodArray = [];
	function generateMonthlyPeriods( sD , eD )
	{					
		var sDate = new Date( parseInt(sD.split("-")[0]), parseInt(sD.split("-")[1]-1), parseInt(sD.split("-")[2]) ) ;
		sDate.setDate(1);
		var eDate = new Date( parseInt(eD.split("-")[0]), parseInt(eD.split("-")[1]-1), parseInt(eD.split("-")[2]) );
		//eDate.setDate(1);				
		
		//alert( sDate );
		//alert( eDate );
		
		while(sDate <= eDate)
		{
			var month = sDate.getMonth() + 1;
			month = ( month  ) > 9 ?  month : "0"+ month;
			
			var dhisDate = sDate.getFullYear() + "" + month;
			periodsStr = ( periodsStr == "" ) ? dhisDate : ( periodsStr + ";" + dhisDate );
	
			periodArray.push( dhisDate );
			
			sDate.setMonth( sDate.getMonth() + 1 );
		}				
	}
	
		
	var jsonData1;
	var jsonData2;
	var jsonData3;
	var pOrgUnits = [];	
	var compulsoryDataElementCount = 0;
	var	orgUnitChildMap = [];
	function loadData()
	{		
		var htmlReport="";
		var ouUIDs = "";
		
		var models = [];
		var refrigerators = [];
		generateMonthlyPeriods( startDate, endDate );
		
		
		//Get Program Information		
		$.get("../../../api/programs/"+ programUID +".json" ,function(json)
		{			
			$.each( json.organisationUnits, function(){
				pOrgUnits.push( this.id );
				ouUIDs += this.id + ";";
			});
			
			// Get tracked entity instances for model
			$.get( "../../../api/trackedEntityInstances.json?program=FGQtsshLDIz&ou=IWp9dQGM0bS&skipPaging=true",function(json3)
			{	
				$.each( json3.trackedEntityInstances, function( index1, tei ){
					$.each( tei.attributes, function( index1, attributeObj ){
						if( attributeObj.attribute == refNetVolumeAttribUID )
							models[ tei.trackedEntityInstance ] = attributeObj;
					});
				});	
				
				console.log( models );
				
				// Get tracked entity instances for refrigerators				
				$.get( "../../../api/trackedEntityInstances.json?program=QkpY35KBO8d&ou="+orgUnitUID+"&ouMode=DESCENDANTS&skipPaging=true",function(json4)
				{
					console.log( json4 );
					// Get data for Population, SupplyInterval , ReserveStockInterval
					var apiURL = "../../../api/analytics.json?dimension=dx:"+ deUIDs +"&dimension=pe:"+ curPeriod +"&dimension=ou:"+ouUIDs;
					$.get( apiURL,function(json2)
					{
						//Get orgunit Hierarchy
						//$.get("../../../api/organisationUnits/"+ orgUnitUID +".json?fields=name,id,level,parent[id],children[id],programs[id]&includeDescendants=true" ,function(json1)
						$.get("../../../api/organisationUnits/"+ orgUnitUID +".json?includeDescendants=true&fields=name,id,level,parents[id,name]" ,function(json1)
						{					
							
							
							$("#"+showingTable+" > thead").html("");
							$("#"+showingTable+" > tbody").html("");
						
							$.each( json1.organisationUnits, function ( index1, oU ) {
								if( pOrgUnits.indexOf( oU.id ) != -1 )
								{
									var ouHierachyNames = "";
									var ouHierarchyUIDs = "";
									$.each( oU.parents, function( index2, ouP){
										ouHierachyNames += ouP.name + " -> ";
										ouHierarchyUIDs += ouP.id + " -> ";
									});
									var progOrgUnit = { id: oU.id, name: oU.name, level: oU.level, ouHierachyNames: ouHierachyNames, ouHierarchyUIDs: ouHierarchyUIDs };
									programOrgUnits.push( progOrgUnit );
								}
							});
							
							programOrgUnits.sort( compareOU );
							
							/*
							$.each( json1.organisationUnits, function ( index1, oU ) {
								orgUnitChildMap[oU.id] = oU; 
							});
											
							var ouLevelCount = 1;
							$.each( json1.organisationUnits, function ( index1, oU ) {
								orgUnitCount = 0;
								if( pOrgUnits.indexOf( oU.id ) == -1 )
								{
									getProgramAssignedOrgUnitCount( oU, pOrgUnits );
									if ( orgUnitCount > 0 )
									{
										var progOrgUnit = { id: oU.id, name: oU.name, level: oU.level };
										programOrgUnits.push( oU );
										if( ouLevelCount <= oU.level )
											ouLevelCount = oU.level;													
									}
								}
								else
								{
									var progOrgUnit = { id: oU.id, name: oU.name, level: oU.level };
									programOrgUnits.push( oU );
									if( ouLevelCount <= oU.level )
											ouLevelCount = oU.level;
								}				
							});
							*/

							htmlReport += "<thead>";
						
							htmlReport += "<tr align='center'  height='27'>";
							htmlReport += "<td colspan='5' height='27' class='col' bgcolor='#32849C' style='color: #ffffff; font-family: Arial; font-size: 14px; font-weight: bold;'><font color='white'><b>Storage capacity report</b></font></td>";
							htmlReport += "</tr>";
						
							htmlReport+="<tbody>";		
								
							htmlReport+="<tr align='center' bgcolor='#32849C' style='color: #ffffff; font-family: Arial; font-size: 12px; font-weight: bold;'>";
							htmlReport+="<td>Orgunit Hierarchy</td>";
							htmlReport+="<td>Orgunit Name</td>";
							htmlReport+="<td>Required</td>";
							htmlReport+="<td>Actual</td>";
							htmlReport+="<td>Shortage?</td>";
							htmlReport+="</tr>";
								
							$.each( programOrgUnits, function( index, oU ){
								htmlReport+="<tr style='color: #000000; font-family: Arial; font-size: 11px; font-weight: bold;'>";		
								htmlReport+="<td>"+ oU.ouHierachyNames +"</td>";
								htmlReport+="<td>"+ oU.name +"</td>";								
								/*	
								for(var i=1; i<= ouLevelCount; i++)
								{
									if( i == oU.level ){
										htmlReport+="<td>" + oU.name + "</td>";
									}
									else{
										htmlReport+="<td>&nbsp;</td>";
									}						
								}					
								*/
								
								var flag = 0;
								if( pOrgUnits.indexOf( oU.id ) == -1 ){
									flag = 1;
								}
									
								if( flag == 0 ){
								
									var actualCapacity = 0.0;
									$.each( json4.trackedEntityInstances, function( index4, tei ){
										$.each( tei.attributes, function( index1, attributeObj ){	
											
											if( attributeObj.attribute == modelAttributeUID &&  tei.orgUnit == oU.id ){												
												var temp = models[ attributeObj.value ];
												
												if (typeof temp === "undefined"){
													//alert( attributeObj.value + " - " + "undefined" );
												}
												else{
													//alert( attributeObj.value + " - " + temp.value );
													actualCapacity += parseFloat(temp.value);
												}
													
											}												
										});
									});
									actualCapacity = Math.round(actualCapacity * 10) / 10;
									
									var popData = parseFloat( getCellValue( json2, dataElements[0].id, curPeriod, oU.id ) );
									var supplyIntervalData = parseFloat( getCellValue( json2, dataElements[1].id, curPeriod, oU.id ) );
									var resStockData = parseFloat( getCellValue( json2, dataElements[2].id, curPeriod, oU.id ) );
									
									var requiredCapacity = popData * birthRate  * vvPerFIChild * ( (supplyIntervalData + resStockData ) / 52);
									requiredCapacity = Math.round(requiredCapacity * 10) / 10;
									
									var shortageCapacity =  actualCapacity  - requiredCapacity;
									var shortage = 'N';
									
									if( shortageCapacity < 0 )
										shortage = 'Y';
									
									htmlReport+="<td align='center'>"+ requiredCapacity +"</td>";
									htmlReport+="<td align='center'>"+ actualCapacity +"</td>";
									if( shortage == 'Y' ){
										htmlReport+="<td align='center' style='color: red;'>"+ shortage +"</td>";
									}
									else{
										htmlReport+="<td align='center' style='color: #000000;'>"+ shortage +"</td>";
									}
									

                                    // create dataValue Json for Push Aggregated Data
                                    for (var k = 0; k < pushDataElements.length; k++)
                                    {
                                        dataValue = {};
                                        dataValue["orgUnit"] = oU.id;
                                        dataValue["period"] = pushPeriod;
                                        // for Actual
                                        if( pushDataElements[k].uid == "kS6oYl9sbkn"  )
                                        {
                                            dataValue["dataElement"] = pushDataElements[k].uid;
                                            dataValue["value"] = actualCapacity;
                                        }
                                        // for Require
                                        else if( pushDataElements[k].uid == "H4uW8k4ZTDI" )
                                        {
                                            dataValue["dataElement"] = pushDataElements[k].uid;
                                            dataValue["value"] = requiredCapacity;
                                        }
                                        // for Shortage
                                        else if( pushDataElements[k].uid == "TCfjFhYzUgm" )
                                        {
                                            dataValue["dataElement"] = pushDataElements[k].uid;
                                            //var shortageCapacity =  actualCapacity  - requiredCapacity;
                                            if( shortageCapacity < 0 )
                                            {
                                                dataValue["value"] = 1;
                                            }
                                            else
                                            {
                                                dataValue["value"] = 0;
                                            }
                                        }

                                        dataValues.push(dataValue);
                                        dataValueSet.dataValues = dataValues;
                                    }

								}
								else{
									htmlReport+="<td>&nbsp;</td>";
									htmlReport+="<td>&nbsp;</td>";
									htmlReport+="<td>&nbsp;</td>";
								}
								
								htmlReport+="</tr>";				
							});
						
							htmlReport+="</tbody>";		
								
							$("#"+showingTable ).append( htmlReport );
							hideLoad();			
						});
					});
				});	
			});		
		});			
	}
	
	function compareOU( a, b ) 
	{
		if( a.ouHierachyNames < b.ouHierachyNames )
			return -1;
		if( a.ouHierachyNames > b.ouHierachyNames )
			return 1;
		return 0;
	}
	
	function getProgramAssignedOrgUnitCount( ou, progOrgunits )
    {
		$.each( ou.children, function( index, child1 ){
			var child = orgUnitChildMap[ child1.id ];
			if( progOrgunits.indexOf( child.id ) != -1 ){			
				orgUnitCount++;
				return;
			}
			getProgramAssignedOrgUnitCount( child, progOrgunits )
		});
	}
	
	
	function loadReport( )
	{
		var htmlReport="";
		var selYear = gotPeriod.substring(0,4);
		var selMonth = gotPeriod.substring(4,6);
		
		$("#"+showingTable+" > tbody").html("");

		$("#"+showingTable+" > thead").html("");
		$("#"+showingTable+" > tbody").html("");
		
		htmlReport += "<thead>";
		
		htmlReport += "<tr align='center'  height='27'>";
		htmlReport += "<td colspan='1' height='27' class='col' bgcolor='#32849C'><font color='white'><b>Data Status</b></font></td>";
		htmlReport += "</tr>";
		
		htmlReport+="<tbody>";		
		
		htmlReport+="<tr>";		
					
		htmlReport+="</tr>";
		
		htmlReport+="</tbody>";		
		$("#"+showingTable ).append( htmlReport );
		hideLoad();
	}

	
	function getCompletenessValue( json, ou, p )
	{
		var result= "0:0";
		for (var i=0; i < json.rows.length; i++)
		{
			
			if( json.rows[i][0] == ou && json.rows[i][1] == p && json.rows[i][2] != null && json.rows[i][3] != null )
			{
				result= json.rows[i][3] + ":" + json.rows[i][2];
				//if( result > 100 ) result = 100;
			}
		}		
		return result;
	}
	
	function getCellValue( json, de, p, ou )
	{
		var result=0;
		for (var i=0; i < json.rows.length; i++)
		{
			if( json.rows[i][0] == de && json.rows[i][1] == p && json.rows[i][2] == ou && json.rows[i][3]!= null )
			{
				result=json.rows[i][3];
			}
		}		
		return result;
	}

</script>


<!-- download script ------------------------------------------------------
		--------------------------------------------------------------------------
		-------------------------------------------------------------------------------------- -->
<script type="text/javascript">
	function convert(dataURI) 
	{
		  // convert base64 to raw binary data held in a string
		  // doesn't handle URLEncoded DataURIs
		  var byteString;
		  if (dataURI.split(',')[0].indexOf('base64') >= 0)
			  byteString = atob(dataURI.split(',')[1]);
		  else
			  byteString = unescape(dataURI.split(',')[1]);
		  // separate out the mime component
		  var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

		  // write the bytes of the string to an ArrayBuffer
		  var ab = new ArrayBuffer(byteString.length);
		  var ia = new Uint8Array(ab);
		  for (var i = 0; i < byteString.length; i++) {
			  ia[i] = byteString.charCodeAt(i);
		  }

		  // write the ArrayBuffer to a blob, and you're done
		  return new Blob([ab],{type: mimeString});
	}

var tablesToExcel = (function() {
var uri ='data:application/vnd.ms-excel;base64,', tmplWorkbookXML ='<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?><Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">'+'<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office"><Author>ThaiND</Author><Created>{created}</Created></DocumentProperties>'+'<Styles><Style ss:ID="Default" ss:Name="Normal"><Alignment ss:Horizontal="Center" ss:WrapText="1"/><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders><Font/><Interior /><NumberFormat /><Protection /></Style><Style ss:ID="s21"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style> <Style ss:ID="s22"><Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /><Borders><Border ss:Position="Bottom" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Top" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Left" ss:LineStyle="Continuous" ss:Weight="1"/><Border ss:Position="Right" ss:LineStyle="Continuous" ss:Weight="1"/></Borders></Style><Style ss:ID="s64"> <Alignment ss:WrapText="1" ss:Horizontal="Center" ss:Vertical="Center" ss:Indent="0" ss:Rotate="90"/><Font ss:Size="10" ss:Bold="1" /><Interior ss:Color="#999999" ss:Pattern="Solid" /> </Style> </Styles>'+'{worksheets}</Workbook>', tmplWorksheetXML ='<Worksheet ss:Name="{nameWS}"><Table><Column ss:AutoFitWidth="0" ss:Width="100"/><Column ss:AutoFitWidth="0" ss:Width="150"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/><Column ss:AutoFitWidth="0" ss:Width="80"/>{rows}</Table></Worksheet>', tmplCellXML ='<Cell ss:StyleID="{sid}" ss:MergeAcross="{mrg}"><Data ss:Type="{dtype}">{data}</Data></Cell>', base64 = function(s) { return window.btoa(unescape(encodeURIComponent(s))) }
    , format = function(s, c) { return s.replace(/{(\w+)}/g, function(m, p) { return c[p]; }) }
	
    return function(tables, wsnames, wbname) {
		var ctx = "";
		var workbookXML = "";
		var worksheetsXML = "";
		var rowsXML = "";
		
		for (var i = 0; i < tables.length; i++) 
		{
		
			if (!tables[i].nodeType) 
			tables[i] = document.getElementById(tables[i]);
		
			for (var j = 0; j < tables[i].rows.length; j++) 
			{
				rowsXML +='<Row>';
				for (var k = 0; k < tables[i].rows[j].cells.length; k++) 
				{
					
					var cols=tables[i].rows[j].cells[k].getAttribute("colspan");
					var rws=tables[i].rows[j].cells[k].getAttribute("rowspan");
					var styl=tables[i].rows[j].cells[k].getAttribute("bgcolor");
					var styl2=tables[i].rows[j].getAttribute("bgcolor");
					var cls=tables[i].rows[j].cells[k].getAttribute("class");
					
						var dataType ='String';
						var dataValue = tables[i].rows[j].cells[k].innerHTML;
						var typeD="";
						var parsed=parseInt(dataValue);
						
						if (parsed==dataValue)
						{
							typeD="Number";
						}
						else
						{
							typeD="String";
						}
					
					
					
					if(styl2)
					{
						if(cols)
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: cols-1, sid:"s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}

						else
						{
							if(cls=="aso")
							{
								ctx = {data: dataValue, mrg: 0, sid:"s64",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
							else
							{
								ctx = {data: dataValue, mrg: 0, sid: "s22",dtype:typeD};
								rowsXML += format(tmplCellXML, ctx);
							}
						}
					}
				
					else if(styl)
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "s21",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					}
					
					else
					{
						if(cols)
						{
							ctx = {data: dataValue, mrg: cols-1, sid:"Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}

						else
						{
							ctx = {data: dataValue, mrg: 0, sid: "Default",dtype:typeD};
							rowsXML += format(tmplCellXML, ctx);
						}
					
					}
					
				}
				  rowsXML +='</Row>'}
			ctx = {rows: rowsXML, nameWS: wsnames[i] ||'Sheet'+ i};
			worksheetsXML += format(tmplWorksheetXML, ctx);
			rowsXML = "";
      }

		ctx = {created: (new Date()).getTime(), worksheets: worksheetsXML};
		workbookXML = format(tmplWorkbookXML, ctx);

		//console.log(workbookXML);

		
		
		var blobUrl = URL.createObjectURL(convert(uri + base64(workbookXML)));
		var link = document.createElement("A");
		link.href = blobUrl;
		//link.href = uri + base64(workbookXML);
		link.download = wbname || 'Workbook.xls';
		link.target = '_blank';
		document.body.appendChild(link);
		link.click();
		document.body.removeChild(link);
    }
  })();

</script>


<style>
	
	td
	{
		padding: 5px 10px;
		font:Arial, Helvetica, sans-serif;
	}
	
	bd
	{
		border-style: solid;
		border-color:#000000;
	}	
	
	#cover{ position:fixed; top:0; left:0; background:rgba(0,0,0,0.7); z-index:5; width:100%; height:100%;}
			#loads { height:100px; width:500px; position:fixed; z-index:10;  margin:0 auto;   top: 50%; left: 50%; margin-top:-50px; margin-left:-250px; background:#999; border:5px solid #cccccc; text-align=center; border-radius:5px; }
			.loading { width:400px; font-size:20px; font-family:verdana; font-weight:bolder; position:fixed;  top: 50%; left: 50%; margin:0 auto; margin-top:-8px; margin-left:-200px;}
			.vtext{
			/*width:1px;
			height: 50px;
			-ms-transform: rotate(90deg);
			-webkit-transform: rotate(90deg); 
			transform: rotate(90deg); 
			border-style: hidden;*/
	}
		
</style>
<!--<div id="loads" > <p class="loading" align="center">Report is loading... please wait...</p></div>
		<div id="cover" > </div>-->
<div id="loads" > <p class="loading" align="center">Report is loading... please wait...</p></div>
		<div id="cover" > </div>
<table>
	<tr>
		<td>
			<input type="button" id="btnExport" value=" Download Excel " />						
		</td>
        <td align="right">
            <input type="button" id="btnPushData"  onclick="pushDataValue();" value=" Push Data " />
        </td>
	</tr>
</table>

<br /><br />

<div id="printing">
	<table border="1" cellspacing="6" cellpadding="4"  id="datavalue1" width="100%" style="border-collapse:collapse; border:2px; font-weight:bolder" ></table>	
</div>
