<script src="libraries/jquery/2.2.3/jquery.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js" integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30=" crossorigin="anonymous"></script>
<script lang="javascript" src="libraries/xlsx/0.11.3/xlsx.full.min.js"></script>
<script lang="javascript" src="libraries/Blob/1.0/Blob.js"></script>
<script lang="javascript" src="libraries/FileSaver/1.3.2/FileSaver.js"></script>
<script lang="javascript" src="commons/tree.js"></script>
<script lang="javascript" src="libraries/jquery-number/jquery.number.js"></script>
<script lang="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.88/jsrender.js"></script>
<script lang="javascript" src="commons/tools.js"></script>
<script lang="javascript" src="commons/api.js"></script>
<script lang="javascript" src="commons/progressBar.js"></script>
<script lang="javascript" src="commons/table.js"></script>
<script lang="javascript" src="commons/feedbacks.js"></script>

<script type="text/javascript">

    /****************************************************************************************************
 	 **********                      	       CONSTANTS            	              	       **********
	 ****************************************************************************************************/


    var FEEDBACK_FILL_ALL_FIELDS = "Please, fill all fields.";
    var FEEDBACK_NO_ORGUNITS = "No orgunits found at the selected level. Please select a closer level to the target orgUnit.";
    var FEEDBACK_SELECT_VALID_COUNTRY = "Please, select a valid country.";

    var ORGUNIT_TEXT = "orgunittree";

    /****************************************************************************************************
 	 **********                      	       VARIABLES            	              	       **********
	 ****************************************************************************************************/
    var organisationUnits = [];

    var variableTasksForTimer = 0;
    var fixedTaskForTimer = 0;




	/****************************************************************************************************
 	 **********                    	    AUXILIARY FUNCTIONS                	           	       **********
	 ****************************************************************************************************/

    function fillOrgUnits(data, length, start){
        var orgUnit;
        for(var i=0;i<length;i++){
            orgUnit = new Object();
            orgUnit.value = data[i].id;
            orgUnit.code = data[i].code;
            orgUnit.label = data[i].displayName;
            organisationUnits.push(orgUnit);
        }
    }




	/****************************************************************************************************
 	 **********                    	                UI FUNCTIONS        	           	       **********
	 ****************************************************************************************************/


    function updateForm(){
        $("#deepLevel").prop('selectedIndex', 0);
        $("#includeIDs").prop('selectedIndex', 1);
        
        var downKeyEvent = $.Event("keydown");
        downKeyEvent.keyCode = $.ui.keyCode.DOWN;  // event for pressing "down" key

        var enterKeyEvent = $.Event("keydown");
        enterKeyEvent.keyCode = $.ui.keyCode.ENTER;  // event for pressing "enter" key


        $("#destinationCountry").val("");
        
    }



	/****************************************************************************************************
 	 **********                    	                  START HERE         	           	       **********
	 ****************************************************************************************************/

    window.dhis2 = window.dhis2 || {};
    dhis2.settings = dhis2.settings || {};
    dhis2.settings.baseUrl = window.location.pathname.split('/')[1];

    $(document).ready(function(){
        
        // Loads menu when baseUrl is ready
        $('<script/>',{type:'text/javascript', src:'../../../dhis-web-commons/javascripts/dhis2/dhis2.translate.js'}).appendTo('head');
        $('<script/>',{type:'text/javascript', src:'../../../dhis-web-commons/javascripts/dhis2/dhis2.menu.js'}).appendTo('head');
        $('<script/>',{type:'text/javascript', src:'../../../dhis-web-commons/javascripts/dhis2/dhis2.menu.ui.js'}).appendTo('head');

       //TODO: Better fix. It resizes the WHO logo
       $("#headerBanner").height("45px");
       $("#headerBanner").css({ top: '2px' });
        
        $.get("../../systemSettings.json" ,function(json)
        {
            $("#headerText").text(json.applicationTitle);
        });


        $( "#tabs" ).tabs({heightStyle: "content"});

        $('#form :input').change(function () {
            updateFeedback(FEEDBACK_HIDE, "feedback", "");

        });



        /******************************************* PROGRESS BAR *****************************************/




        
        $.when(getNumberOfDivisions(1, "id,code,displayName"),
        getNumberOfDivisions(2, "id,code,displayName"),
        getNumberOfDivisions(3, "id,code,displayName"))
        .done(function(nbOfDivisions1, nbOfDivisions2, nbOfDivisions3){

            fillOrgUnits(nbOfDivisions1.organisationUnits, nbOfDivisions1.organisationUnits.length);
            fillOrgUnits(nbOfDivisions2.organisationUnits, nbOfDivisions2.organisationUnits.length);
            fillOrgUnits(nbOfDivisions3.organisationUnits, nbOfDivisions3.organisationUnits.length);

            generateAutoComplete("destinationCountry", organisationUnits);

            initializeProgressBar("progressbar", "dialog");
            updateForm();

        });

 

        /**
        * Generates an autocomplete into an input field
        * It only let to write a item in the source
        * source: array of items with label and value 
        */
        function generateAutoComplete (fieldName, source){
            $( "#" + fieldName ).autocomplete({
                source: source,
                  /* snip */
                select: function(event, ui) {
                    event.preventDefault();
                    $("#" + fieldName ).val(ui.item.label);
                    $("#" + fieldName ).text(ui.item.value);
                },
                focus: function(event, ui) {
                    event.preventDefault();
                    $("#" + fieldName ).val(ui.item.label);
                    $("#" + fieldName ).text(ui.item.value);

                },
                change: function (event, ui) {
                if(!ui.item){
                    //http://api.jqueryui.com/autocomplete/#event-change -
                    // The item selected from the menu, if any. Otherwise the property is null
                    //so clear the item for force selection
                    $("#" + fieldName ).val("");
                    $("#" + fieldName ).text("");
                }

            }
            });

        }


       /****************************************************************************************************
        *                      	                  INTERACTION         	                       	           *
        ****************************************************************************************************/


     $( "#step1" ).click(function() {
            console.log( "Handler for .click() called." );
            openProgressBar(INDETERMINATE);
            // retrieves values from form
            //var returnValues = getValueFrom([ "destinationCountry", "deepLevel"]);
            
            // retrieves values from form
            var countryName =  $( "#destinationCountry" ).val(); 
            var countryID =  $( "#destinationCountry" ).text(); 
            var countryCode =  organisationUnits[organisationUnits.findIndex(x => x.value === countryID)].code;
            var deepLevel =  $( "#deepLevel" ).val(); 
            var includeIDs =  $( "#includeIDs" ).val(); 

            // Checks if all fields are filled and if the country is in the original list
            if (countryID == ""){
              //  updateFeedback(FEEDBACK_FILL_ALL_FIELDS, "isa_info", "fa fa-info-circle");
                updateFeedback(FEEDBACK_WARNING, "feedback", FEEDBACK_FILL_ALL_FIELDS);
                closeProgressBar();

            //} else if (notValidCountry(countryID)){
            //    updateFeedback(FEEDBACK_SELECT_VALID_COUNTRY, "isa_info", "fa fa-info-circle");
            } else {
    
                var tree = new Tree(countryID, countryCode, countryName);
                variableTasksForTimer = Number(deepLevel);
                var intDeepLevel = parseInt(deepLevel);
                fixedTaskForTimer = 1;
                $.when( getAndBuildOrgUnitTree(tree, countryID, 1, Number(deepLevel), "id,code,displayName,parent", progressBarAdd))
                .done(function(tree){

                    var header = [];
                    var level0_array = [];
                    switch(includeIDs){
                        case NO_ID:
                            level0_array = [tree._root.name];
                            for (var i = 0; i<=intDeepLevel; i++){
                                header.push("Level "+i);
                            }
                            break;
                        case LAST_LEVEL_ID:
                            level0_array = [tree._root.id, tree._root.code, tree._root.name];
                            header = ["UID", "code"];
                            for (var i = 0; i<=intDeepLevel; i++){
                                header.push("Level "+i);
                            }
                            break;
                        case ALL_ID:
                            level0_array = [tree._root.id, tree._root.code, tree._root.name];
                            for (var i = 0; i<=intDeepLevel; i++){
                                header.push("UID Level "+ i );
                                header.push("code Level "+ i );
                                header.push("Level "+ i);
                            }                            
                            break;                        
                    }
                    var data = [header];
                
                    if (typeof tree._root.children != "undefined" && tree._root.children != null && tree._root.children.length > 0){
                        data = treePathsToArray(data, tree._root.children, level0_array, 0, Number(deepLevel), includeIDs);
                    } else {
                        // Level 0
                        data.push(level0_array);
                    }
                   
                    //Asave as Excel
                    var wb = new Workbook();
                    var ws1 = sheet_from_array_of_arrays(data);
                    /* add worksheet to workbook */
                    wb.SheetNames.push(ws_main_page);
                    wb.Sheets[ws_main_page] = ws1;
                    var wbout = XLSX.write(wb, {bookType:'xlsx', bookSST:true, type: 'binary'});
                    saveAs(new Blob([s2ab(wbout)],{type:"application/octet-stream"}), ORGUNIT_TEXT+"_"+countryName+"_level_"+deepLevel+".xlsx");
                  //  progressBarAdd(100/(variableTasksForTimer+fixedTaskForTimer));
                    closeProgressBar();
                   // moveToTab(dataStore.completedPhases);
                })
                .fail(function(data){
                    updateFeedback(FEEDBACK_ERROR, "feedback", FEEDBACK_NO_ORGUNITS + "<br><br> Error details:<br>" + data.responseJSON.message);
                    closeProgressBar();
                });

            }
        });
   

    });



    function datenum(v, date1904) {
        if(date1904) v+=1462;
        var epoch = Date.parse(v);
        return (epoch - new Date(Date.UTC(1899, 11, 30))) / (24 * 60 * 60 * 1000);
    }
     
    function sheet_from_array_of_arrays(data, opts) {
        var ws = {};
        var range = {s: {c:10000000, r:10000000}, e: {c:0, r:0 }};
        for(var R = 0; R != data.length; ++R) {
            for(var C = 0; C != data[R].length; ++C) {
                if(range.s.r > R) range.s.r = R;
                if(range.s.c > C) range.s.c = C;
                if(range.e.r < R) range.e.r = R;
                if(range.e.c < C) range.e.c = C;
                var cell = {v: data[R][C] };
                if(cell.v == null) continue;
                var cell_ref = XLSX.utils.encode_cell({c:C,r:R});
                
                if(typeof cell.v === 'number') cell.t = 'n';
                else if(typeof cell.v === 'boolean') cell.t = 'b';
                else if(cell.v instanceof Date) {
                    cell.t = 'n'; cell.z = XLSX.SSF._table[14];
                    cell.v = datenum(cell.v);
                }
                else cell.t = 's';
                
                ws[cell_ref] = cell;
            }
        }
        if(range.s.c < 10000000) ws['!ref'] = XLSX.utils.encode_range(range);
        return ws;
    }
     
    /* original data */
   
    var ws_main_page = "Data";
    
    function Workbook() {
        if(!(this instanceof Workbook)) return new Workbook();
        this.SheetNames = [];
        this.Sheets = {};
    }
     
   
    
    function s2ab(s) {
        var buf = new ArrayBuffer(s.length);
        var view = new Uint8Array(buf);
        for (var i=0; i!=s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
    </script>

<!DOCTYPE html>
<html lang="en">
	<head>
		<title>OrgUnit Tree Flatter</title>
		<meta charset="utf-8">	
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="commons/feedbacks.css">
        
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

        <!-- Stylesheets related to the menu -->
		<link type="text/css" rel="stylesheet" href="../../../dhis-web-commons/font-awesome/css/font-awesome.min.css"/>
		<link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/css/menu.css"> 
		<link type="text/css" rel="stylesheet" media="screen" href="../../../dhis-web-commons/css/light_blue/light_blue.css?_rev=22006" />

        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        

    </head>
	<body>
        <div id="header" class="non-printable">
			<img id="headerBanner" src="../../staticContent/logo_banner" onclick="window.location.href='../../../dhis-web-commons-about/redirect.action'"
				style="cursor:pointer" title="View home page">

			<span id="headerText" onclick="window.location.href='../../../dhis-web-commons-about/redirect.action'" style="cursor:pointer" title="View home page">
				DHIS 2
			</span>

			<div id="dhisDropDownMenu"></div>
			
		
		</div>
        <div id="container" class="non-printable">

            <div class="content-area">
                <div id="tabs">
                    <ul>
                        <li><a href="#tabs-1">Download OrgUnit Tree</a></li>
                    </ul>
                    <div id="tabs-1">	
                        <fieldset id="form" >
                            <legend>Select the target country and its depth level</legend>
                            <table style="width:100%">
        
                                <tr>
                                    <div class="ui-widget">
                                        <td><label for="destinationCountry">OrgUnit (Global, Region, Country): </label></td>
                                        <td><input id="destinationCountry"></td>
                                    </div>
                                    
                                </tr>
                                <tr>
                                    <td><label  for="deepLevel">Depth level</label></td>
                                    <td><select  name="deepLevel" id="deepLevel">
                                        <option value ="0" >Level 0 (Selected OrgUnit)</option>
                                        <option value ="1" >Level 1</option>
                                        <option value ="2" >Level 2</option>
                                        <option value ="3" >Level 3</option>
                                        <option value ="4" >Level 4</option>
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><label  for="includeIDs">IDs and CODEs to include</label></td>
                                    <td><select  name="includeIDs" id="includeIDs">
                                        <option value ="NO_ID" >Do not include</option>
                                        <option value ="LAST_LEVEL" >Last level only</option>
                                        <option value ="ALL" >IDs and CODEs for each level</option>
                                    </select></td>
                                </tr>
                                <tr>
                                    <td><button id="step1" class="ui-button ui-widget ui-corner-all">Download</button></td>
                                </tr>
                            </table>

                        </fieldset>
                    </div>

                </div>
                <div id="footer"> OrgUnit Tree Flatter v1.3 - 16/09/2020</div>
     
                <div id="feedback" class="">
                    <i class="fa "></i>
                    <div></div>
                    
                </div>
            </div>
        </div>
        
        <div id="dialog" title="Please wait">
                <div class="progress-label">The operation can take several minutes...</div>
                <div id="progressbar"></div>
        </div>

 
    </body>
</html>